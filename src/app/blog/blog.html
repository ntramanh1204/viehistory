<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Blog - VieHistory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon -->
    <link rel="icon" href="/src/assets/icons/logo.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="/src/assets/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="/src/assets/js/utils/url-protection.js"></script>
</head>
<body>
    <!-- Header -->
    <div w3-include-html="/src/components/header.html"></div>
    
    <!-- Navbar -->
    <div w3-include-html="/src/components/navbar.html"></div>
    
    <!-- Blog Hero Section -->
    <section class="bg-primary text-white py-4 mb-4">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-5 fw-bold mb-2">
                        <i class="fas fa-blog me-3"></i>Blog Lịch sử Việt Nam
                    </h1>
                    <p class="lead mb-0">Khám phá những câu chuyện lịch sử thú vị và chia sẻ kiến thức về văn hóa Việt Nam</p>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-scroll" style="font-size: 80px; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container">
        <div class="row">
            <div class="col-lg-9">
                <!-- Blog Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" placeholder="Tìm kiếm bài viết..." id="search-input">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="category-filter">
                                    <option value="">Tất cả chủ đề</option>
                                    <option value="ancient">Lịch sử cổ đại</option>
                                    <option value="medieval">Thời trung đại</option>
                                    <option value="modern">Lịch sử cận đại</option>
                                    <option value="culture">Văn hóa</option>
                                    <option value="people">Nhân vật</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sort-filter">
                                    <option value="newest">Mới nhất</option>
                                    <option value="popular">Phổ biến</option>
                                    <option value="most-viewed">Xem nhiều</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Featured Post -->
                <section class="mb-5">
                    <h2 class="section-title mb-4">
                        <i class="fas fa-star me-2"></i>Bài viết nổi bật
                    </h2>
                    <div id="featured-post">
                        <!-- Bài viết nổi bật sẽ được render ở đây -->
                    </div>
                </section>

                <!-- All Posts -->
                <section class="mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="section-title mb-0">
                            <i class="fas fa-newspaper me-2"></i>Tất cả bài viết
                        </h2>
                        <span class="badge bg-primary" id="posts-count">0 bài viết</span>
                    </div>
                    
                    <div class="row" id="all-posts">
                        <!-- Bài viết sẽ được render ở đây bằng JS -->
                    </div>

                    <!-- Loading indicator -->
                    <div class="text-center py-4 d-none" id="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>

                    <!-- Load more button -->
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-primary" id="load-more">
                            <i class="fas fa-plus me-2"></i>Xem thêm bài viết
                        </button>
                    </div>
                </section>
            </div>

            <div class="col-lg-3">
                <!-- Search widget -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-search me-2"></i>Tìm kiếm nâng cao
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Theo tác giả</label>
                            <input type="text" class="form-control form-control-sm" placeholder="Tên tác giả">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Theo thời gian</label>
                            <select class="form-select form-select-sm">
                                <option value="">Tất cả</option>
                                <option value="today">Hôm nay</option>
                                <option value="week">Tuần này</option>
                                <option value="month">Tháng này</option>
                                <option value="year">Năm nay</option>
                            </select>
                        </div>
                        <button class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-search me-1"></i>Tìm kiếm
                        </button>
                    </div>
                </div>

                <!-- Popular Tags -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-tags me-2"></i>Thẻ phổ biến
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-1" id="popular-tags">
                            <span class="badge bg-light text-dark">Triều Nguyễn</span>
                            <span class="badge bg-light text-dark">Hồ Chí Minh</span>
                            <span class="badge bg-light text-dark">Di tích</span>
                            <span class="badge bg-light text-dark">Văn hóa</span>
                            <span class="badge bg-light text-dark">Trần Dynasty</span>
                            <span class="badge bg-light text-dark">Lê Dynasty</span>
                            <span class="badge bg-light text-dark">Phật giáo</span>
                            <span class="badge bg-light text-dark">Nghệ thuật</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Comments -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-comments me-2"></i>Bình luận gần đây
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="border-bottom pb-2 mb-2">
                                <strong>Nguyễn Văn A</strong> đã bình luận về <a href="#" class="text-decoration-none">"Lịch sử triều Nguyễn"</a>
                                <div class="text-muted">2 giờ trước</div>
                            </div>
                            <div class="border-bottom pb-2 mb-2">
                                <strong>Trần Thị B</strong> đã bình luận về <a href="#" class="text-decoration-none">"Văn hóa Hue"</a>
                                <div class="text-muted">5 giờ trước</div>
                            </div>
                            <div>
                                <strong>Lê Văn C</strong> đã bình luận về <a href="#" class="text-decoration-none">"Di tích Hội An"</a>
                                <div class="text-muted">1 ngày trước</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-list me-2"></i>Chủ đề
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Lịch sử cổ đại</span>
                            <span class="badge bg-secondary">12</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Thời trung đại</span>
                            <span class="badge bg-secondary">8</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Lịch sử cận đại</span>
                            <span class="badge bg-secondary">15</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Văn hóa</span>
                            <span class="badge bg-secondary">23</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Nhân vật lịch sử</span>
                            <span class="badge bg-secondary">18</span>
                        </div>
                    </div>
                </div>

                <!-- Newsletter -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-envelope me-2"></i>Đăng ký nhận tin
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">Nhận thông báo về bài viết mới và sự kiện lịch sử.</p>
                        <div class="input-group">
                            <input type="email" class="form-control form-control-sm" placeholder="Email của bạn">
                            <button class="btn btn-dark btn-sm">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div w3-include-html="/src/components/footer.html"></div>

    <!-- JS -->
 <!-- ...existing HTML code... -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore-compat.js"></script>
<script src="/src/assets/js/bundle.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    function waitForDbAndRun(fn, tries = 10) {
        if (window.db) {
            fn(window.db);
        } else if (tries > 0) {
            setTimeout(() => waitForDbAndRun(fn, tries - 1), 200);
        } else {
            console.error('Không thể khởi tạo Firestore!');
        }
    }

    waitForDbAndRun(function(db) {
        let currentPage = 1;
        const postsPerPage = 6;
        let allPosts = [];
        let filteredPosts = [];

        function renderPost(post, docId, isFeatured = false) {
            if (isFeatured) {
                return `
                    <div class="card post-card mb-4">
                        <div class="row g-0">
                            <div class="col-md-4">
                                <img src="${post.image || 'https://via.placeholder.com/400x250?text=No+Image'}" 
                                     class="img-fluid rounded-start h-100" alt="${post.title}" style="object-fit: cover;">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body">
                                    <div class="mb-2">
                                        <span class="badge bg-primary">${post.category || 'Chung'}</span>
                                        <small class="text-muted ms-2">
                                            <i class="fas fa-clock me-1"></i>${post.timeAgo || ''}
                                        </small>
                                    </div>
                                    <h3 class="card-title">${post.title}</h3>
                                    <p class="card-text">${post.summary || ''}</p>
                                    <div class="mb-3">
                                        ${post.tags ? post.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : ''}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted">
                                            <i class="fas fa-eye me-1"></i>${post.views || 0}
                                            <i class="fas fa-heart ms-2 me-1"></i>${post.likes || 0}
                                            <i class="fas fa-comments ms-2 me-1"></i>${post.comments || 0}
                                        </div>
                                        <a href="/blog/${docId}" class="btn btn-primary">
                                            Đọc bài viết <i class="fas fa-arrow-right ms-1"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card post-card h-100">
                            <div class="position-relative">
                                <img src="${post.image || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                                     class="card-img-top" alt="${post.title}" style="height: 200px; object-fit: cover;">
                                <span class="category-badge">${post.category || 'Chung'}</span>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${post.title}</h5>
                                <p class="card-text text-muted flex-grow-1">${post.summary || ''}</p>
                                <div class="mb-3">
                                    ${post.tags ? post.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : ''}
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>${post.readTime || 5} phút đọc
                                    </small>
                                    <small class="text-muted">${post.timeAgo || ''}</small>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted small">
                                        <i class="fas fa-eye me-1"></i>${post.views || 0}
                                        <i class="fas fa-heart ms-2 me-1"></i>${post.likes || 0}
                                        <i class="fas fa-comments ms-2 me-1"></i>${post.comments || 0}
                                    </div>
                                    <a href="/blog/${docId}" class="btn btn-primary btn-sm">
                                        Đọc thêm <i class="fas fa-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function timeAgo(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const time = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diffMs = now - time;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays > 0) return `${diffDays} ngày trước`;
            if (diffHours > 0) return `${diffHours} giờ trước`;
            return 'Vừa xong';
        }

        // Load featured post
        function loadFeaturedPost() {
            db.collection('posts')
                .where('featured', '==', true)
                .limit(1)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        const post = doc.data();
                        post.timeAgo = timeAgo(post.createdAt);
                        document.getElementById('featured-post').innerHTML = renderPost(post, doc.id, true);
                    } else {
                        document.getElementById('featured-post').innerHTML = '';
                    }
                })
                .catch(err => console.error('Error loading featured post:', err));
        }

        // Load all posts
        function loadAllPosts() {
            document.getElementById('loading').classList.remove('d-none');
            db.collection('posts')
                .orderBy('createdAt', 'desc')
                .get()
                .then(snapshot => {
                    allPosts = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        allPosts.push({
                            id: doc.id,
                            title: data.title,
                            summary: data.summary,
                            image: data.image,
                            category: data.category,
                            tags: data.tags,
                            views: data.views,
                            likes: data.likes,
                            comments: data.comments,
                            readTime: data.readTime,
                            timeAgo: timeAgo(data.createdAt),
                            createdAt: data.createdAt,
                            featured: data.featured
                        });
                    });
                    filteredPosts = [...allPosts];
                    renderPosts();
                    updatePostsCount();
                    document.getElementById('loading').classList.add('d-none');
                })
                .catch(err => {
                    document.getElementById('all-posts').innerHTML = '<div class="col-12 text-danger">Không thể tải bài viết.</div>';
                    document.getElementById('loading').classList.add('d-none');
                    console.error(err);
                });
        }

        // Render posts with pagination
        function renderPosts() {
            const startIndex = 0;
            const endIndex = currentPage * postsPerPage;
            const postsToShow = filteredPosts.slice(startIndex, endIndex);
            document.getElementById('all-posts').innerHTML = postsToShow
                .filter(post => !post.featured)
                .map(post => renderPost(post, post.id))
                .join('');
            // Show/hide load more button
            const loadMoreBtn = document.getElementById('load-more');
            if (endIndex >= filteredPosts.length) {
                loadMoreBtn.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'block';
            }
        }

        // Update posts count
        function updatePostsCount() {
            document.getElementById('posts-count').textContent = `${filteredPosts.length} bài viết`;
        }

        // Filter and search functionality
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const sortBy = document.getElementById('sort-filter').value;
            filteredPosts = allPosts.filter(post => {
                const matchesSearch = !searchTerm ||
                    post.title.toLowerCase().includes(searchTerm) ||
                    (post.summary && post.summary.toLowerCase().includes(searchTerm));
                const matchesCategory = !category || post.category === category;
                return matchesSearch && matchesCategory;
            });
            // Sort posts
            switch(sortBy) {
                case 'popular':
                    filteredPosts.sort((a, b) => (b.likes || 0) - (a.likes || 0));
                    break;
                case 'most-viewed':
                    filteredPosts.sort((a, b) => (b.views || 0) - (a.views || 0));
                    break;
                default: // newest
                    filteredPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            }
            currentPage = 1;
            renderPosts();
            updatePostsCount();
        }

        // Event listeners
        document.getElementById('search-input').addEventListener('input', applyFilters);
        document.getElementById('category-filter').addEventListener('change', applyFilters);
        document.getElementById('sort-filter').addEventListener('change', applyFilters);
        document.getElementById('load-more').addEventListener('click', () => {
            currentPage++;
            renderPosts();
        });

        // Initialize page
        loadFeaturedPost();
        loadAllPosts();
    });
});
</script>
</body>
</html>