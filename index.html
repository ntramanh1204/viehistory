<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>VieHistory - Trang chủ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Favicon -->
    <link rel="icon" href="src\assets\icons\logo.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="/src/assets/css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="/src/assets/js/utils/url-protection.js"></script>
</head>

<body>
    <!-- Header -->
    <div w3-include-html="/src/components/header.html"></div>

    <!-- Navbar -->
    <div w3-include-html="/src/components/navbar.html"></div>

    <!-- Hero Banner -->
    <section class="hero-banner">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-3">Khám phá Lịch sử Việt Nam</h1>
                    <p class="lead mb-4">Nơi giao lưu, chia sẻ và khám phá những câu chuyện lịch sử Việt Nam đầy thú vị
                    </p>
                    <a href="/forum" class="btn btn-light btn-lg me-3">
                        <i class="fas fa-comments me-2"></i>Tham gia Diễn đàn
                    </a>
                    <a href="/store" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-shopping-cart me-2"></i>Khám phá Sản phẩm
                    </a>
                </div>
                <div class="col-lg-4 text-center">
                    <i class="fas fa-landmark" style="font-size: 120px; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container my-4">
        <div class="row">
            <div class="col-lg-9">
                <!-- Bài viết mới nhất -->
                <section class="mb-5">
                    <h2 class="section-title">
                        <i class="fas fa-newspaper me-2"></i>Bài viết mới nhất
                    </h2>
                    <div class="row" id="latest-posts">
                        <!-- Bài viết sẽ được render ở đây bằng JS -->
                    </div>
                </section>


                <!-- Bài viết phổ biến -->
                <!-- <section class="mb-5">
                    <h2 class="section-title">
                        <i class="fas fa-fire me-2"></i>Bài viết phổ biến
                    </h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card post-card">
                                <div class="row g-0">
                                    <div class="col-4">
                                        <img src="https://via.placeholder.com/150x100?text=Địa+danh" class="img-fluid rounded-start h-100" alt="Địa danh">
                                    </div>
                                    <div class="col-8">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">Những địa danh lịch sử nổi tiếng</h6>
                                            <p class="card-text small text-muted">Khám phá các di tích lịch sử...</p>
                                            <small class="text-muted">3.2k lượt xem</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card post-card">
                                <div class="row g-0">
                                    <div class="col-4">
                                        <img src="https://via.placeholder.com/150x100?text=Biểu+tượng" class="img-fluid rounded-start h-100" alt="Biểu tượng">
                                    </div>
                                    <div class="col-8">
                                        <div class="card-body p-3">
                                            <h6 class="card-title">Biểu tượng văn hóa Việt Nam</h6>
                                            <p class="card-text small text-muted">Ý nghĩa các biểu tượng truyền thống...</p>
                                            <small class="text-muted">2.8k lượt xem</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section> -->
            </div>

            <div class="col-lg-3">
                <!-- Sidebar: chủ đề hot, bài mới, quảng cáo -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-fire me-2"></i>Chủ đề HOT
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-hashtag text-primary me-2"></i>
                            <div>
                                <div class="fw-bold">Triều Nguyễn</div>
                                <small class="text-muted">125 thảo luận</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-hashtag text-primary me-2"></i>
                            <div>
                                <div class="fw-bold">Nhân vật lịch sử</div>
                                <small class="text-muted">89 thảo luận</small>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-hashtag text-primary me-2"></i>
                            <div>
                                <div class="fw-bold">Di tích cổ</div>
                                <small class="text-muted">67 thảo luận</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sản phẩm nổi bật -->
                <!-- <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-shopping-cart me-2"></i>Sản phẩm nổi bật
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <img src="https://via.placeholder.com/150x100?text=Sách+lịch+sử" class="img-fluid rounded" alt="Sách">
                            <h6 class="mt-2">Sách Lịch sử Việt Nam</h6>
                            <div class="text-primary fw-bold">299.000 VNĐ</div>
                            <button class="btn btn-success btn-sm mt-2">
                                <i class="fas fa-cart-plus me-1"></i>Xem ngay
                            </button>
                        </div>
                    </div>
                </div> -->

                <!-- Thống kê -->
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-chart-bar me-2"></i>Thống kê
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="fw-bold text-primary fs-4">121</div>
                                <small class="text-muted">Thành viên</small>
                            </div>
                            <div class="col-6">
                                <div class="fw-bold text-success fs-4">31</div>
                                <small class="text-muted">Bài viết</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div w3-include-html="/src/components/footer.html"></div>

    <!-- JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore-compat.js"></script>
    <script src="/src/assets/js/core/firebase-config.js"></script> 
    <script src="/src/assets/js/bundle.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Đợi window.db đã được bundle.js khởi tạo
    function waitForDbAndRun(fn, tries = 10) {
        if (window.db) {
            fn(window.db);
        } else if (tries > 0) {
            setTimeout(() => waitForDbAndRun(fn, tries - 1), 200);
        } else {
            console.error('Không thể khởi tạo Firestore!');
        }
    }

    waitForDbAndRun(function(db) {
        function renderPost(post, docId) {
            return `
                <div class="col-md-6 col-lg-4">
                    <div class="card post-card h-100">
                        <div class="position-relative">
                            <img src="${post.image || 'https://via.placeholder.com/300x200?text=No+Image'}" class="card-img-top" alt="${post.title}" style="height: 200px; object-fit: cover;">
                            <span class="category-badge">${post.category || ''}</span>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${post.title}</h5>
                            <p class="card-text text-muted flex-grow-1">${post.summary || ''}</p>
                            <div class="mb-3">
                                ${post.tags ? post.tags.map(tag => `<span class="badge bg-secondary me-1">${tag}</span>`).join('') : ''}
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>${post.readTime || 5} phút đọc
                                </small>
                                <small class="text-muted">${post.timeAgo || ''}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-eye me-1"></i>${post.views || 0}
                                    <i class="fas fa-heart ms-2 me-1"></i>${post.likes || 0}
                                    <i class="fas fa-comments ms-2 me-1"></i>${post.comments || 0}
                                </div>
                                <a href="/blog/${docId}" class="btn btn-primary btn-sm">
                                    Đọc thêm <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function timeAgo(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return `${diff} giây trước`;
            if (diff < 3600) return `${Math.floor(diff / 60)} phút trước`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} giờ trước`;
            return `${Math.floor(diff / 86400)} ngày trước`;
        }

        db.collection('posts')
            .orderBy('createdAt', 'desc')
            .limit(3)
            .get()
            .then(snapshot => {
                const posts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    posts.push({
                        id: doc.id,
                        title: data.title,
                        summary: data.summary,
                        image: data.image,
                        category: data.category,
                        tags: data.tags,
                        views: data.views,
                        likes: data.likes,
                        comments: data.comments,
                        readTime: data.readTime,
                        timeAgo: timeAgo(data.createdAt)
                    });
                });
                document.getElementById('latest-posts').innerHTML = posts.map(post => renderPost(post, post.id)).join('');
            })
            .catch(err => {
                document.getElementById('latest-posts').innerHTML = '<div class="col-12 text-danger">Không thể tải bài viết.</div>';
                console.error(err);
            });
    });
});
</script>
</body>

</html>